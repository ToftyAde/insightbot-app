{% extends "layout.html" %}
{% block title %}Articles — InsightBot{% endblock %}
{% block content %}

{# Safe defaults so page never crashes #}
{% set q = q|default('') %}
{% set language = language|default('All') %}
{% set source = source|default('All') %}
{% set date = date|default('') %}
{% set languages = languages|default(['All']) %}
{% set sources = sources|default(['All']) %}
{% set items = items|default([]) %}
{% set total = total|default(0) %}
{% set page = page|default(1) %}
{% set per_page = per_page|default(24) %}

{# Flag assets for chips (if files exist) #}
{% set flag_src = {'English':'img/flags/gb.svg','Arabic':'img/flags/sa.svg','Russian':'img/flags/ru.svg'} %}

<section class="container">

  <!-- Filters bar -->
  <form class="filters" method="get" action="{{ url_for('articles') }}">
    <input type="text" name="q" value="{{ q }}" placeholder="Search articles...">

    <select name="language">
      {% for lang in languages %}
        <option value="{{ lang }}" {% if lang==language %}selected{% endif %}>{{ lang }}</option>
      {% endfor %}
    </select>

    <select name="source">
      {% for s in sources %}
        <option value="{{ s }}" {% if s==source %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>

    <select name="date">
      <option value=""      {% if date=='' %}selected{% endif %}>Any time</option>
      <option value="today" {% if date=='today' %}selected{% endif %}>Today</option>
      <option value="7d"    {% if date=='7d' %}selected{% endif %}>Last 7 days</option>
      <option value="30d"   {% if date=='30d' %}selected{% endif %}>Last 30 days</option>
    </select>

    <button class="btn" type="submit">Apply</button>
    <a class="btn ghost" href="{{ url_for('export_csv', q=q, language=language, source=source, date=date) }}">Export CSV</a>
  </form>

  {% if total == 0 %}
    <div class="empty">
      No articles yet. Drop CSVs into <code>data/processed/latest</code> and refresh.
    </div>
  {% else %}
    <div class="grid">
      {% for a in items %}
        <article class="card" {% if a.language and a.language|lower == 'arabic' %}dir="rtl"{% endif %}>
          <div class="card-head">
            <div class="favicon">
              <img src="https://www.google.com/s2/favicons?sz=32&domain={{ a.host or a.source }}" alt="">
            </div>
            <div class="meta">
              <div class="source">{{ a.source }}</div>
              <div class="date">{{ a.date }}</div>
            </div>
          </div>

          <h3 class="title">
            {% if a.url %}<a href="{{ a.url }}" target="_blank" rel="noopener">{{ a.title }}</a>
            {% else %}{{ a.title }}{% endif %}
          </h3>

          <p class="body">
            {{ a.body[:220] }}{% if a.body and a.body|length > 220 %}…{% endif %}
          </p>

          <div class="tags">
            {% if a.language %}
              <span class="chip">
                {% if a.language in flag_src %}
                  <img class="flag-img" src="{{ url_for('static', filename=flag_src[a.language]) }}" alt="{{ a.language }} flag">
                {% endif %}
                {{ a.language }}
              </span>
            {% else %}
              <span class="chip">—</span>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>

    <div class="pagination">
      {% if page > 1 %}
        <a class="btn ghost" href="{{ url_for('articles', q=q, language=language, source=source, date=date, page=page-1) }}">Prev</a>
      {% endif %}
      <span>Page {{ page }}</span>
      {% if (page * per_page) < total %}
        <a class="btn ghost" href="{{ url_for('articles', q=q, language=language, source=source, date=date, page=page+1) }}">Next</a>
      {% endif %}
    </div>
  {% endif %}
</section>
{% endblock %}
